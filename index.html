<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Paparan Aktiviti APM Klang</title>
  <style>
    :root {
      --bg: #020617;
      --bg-card: #020617;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.25);
      --text: #e5e7eb;
      --muted: #9ca3af;
      --danger: #f97373;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #1f2937 0, #020617 40%, #000 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 16px;
    }

    .container {
      width: 100%;
      max-width: 1100px;
    }

    header {
      text-align: center;
      margin-bottom: 16px;
    }

    header h1 {
      font-size: 1.8rem;
      font-weight: 700;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    header p {
      margin-top: 4px;
      font-size: 0.9rem;
      color: var(--muted);
    }

    .card {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.9));
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.75);
      border: 1px solid rgba(148, 163, 184, 0.2);
      backdrop-filter: blur(12px);
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .toolbar-left {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--accent-soft);
      font-size: 0.75rem;
      color: var(--accent);
      background: rgba(15, 23, 42, 0.9);
    }

    .badge-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.95);
    }

    .last-update {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: flex-end;
    }

    .search-box {
      flex: 1;
      min-width: 170px;
      display: flex;
      align-items: center;
      gap: 6px;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 999px;
      padding: 6px 12px;
      border: 1px solid rgba(148, 163, 184, 0.5);
    }

    .search-box span {
      font-size: 0.8rem;
    }

    .search-box input {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      color: var(--text);
      font-size: 0.85rem;
    }

    .search-box input::placeholder {
      color: var(--muted);
    }

    .select-small {
      background: rgba(15, 23, 42, 0.9);
      color: var(--text);
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      padding: 6px 10px;
      font-size: 0.8rem;
      outline: none;
    }

    .refresh-btn {
      background: var(--accent);
      color: #0b1120;
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      box-shadow: 0 8px 20px rgba(56, 189, 248, 0.4);
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.1s ease;
    }

    .refresh-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(56, 189, 248, 0.6);
      background: #0ea5e9;
    }

    .refresh-btn:active {
      transform: translateY(0);
      box-shadow: 0 6px 14px rgba(56, 189, 248, 0.4);
    }

    .table-wrapper {
      margin-top: 8px;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.4);
      max-height: 70vh;
      overflow-y: auto;
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.08), rgba(15, 23, 42, 0.97));
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 1;
      background: linear-gradient(90deg, rgba(15, 23, 42, 0.98), rgba(8, 47, 73, 0.98));
    }

    th, td {
      padding: 9px 10px;
      border-bottom: 1px solid rgba(30, 64, 175, 0.4);
      text-align: left;
      vertical-align: top;
    }

    th {
      font-weight: 700;
      font-size: 0.82rem;
      color: #e5e7eb;
      white-space: nowrap;
    }

    tbody tr:nth-child(even) {
      background-color: rgba(15, 23, 42, 0.93);
    }

    tbody tr:nth-child(odd) {
      background-color: rgba(15, 23, 42, 0.8);
    }

    tbody tr:hover {
      background: rgba(30, 64, 175, 0.65);
    }

    td {
      color: #e5e7eb;
    }

    /* Kolum tarikh kecil & tetap */
    th.col-tarikh,
    td.col-tarikh {
      width: 90px;
      min-width: 90px;
      max-width: 90px;
      white-space: nowrap;
      text-align: center;
      font-weight: 600;
      font-size: 0.85rem;
    }

    .col-perihal {
      font-weight: 500;
    }

    .col-tempat,
    .col-catat {
      font-size: 0.82rem;
      color: var(--muted);
    }

    /* Pastikan teks selain tarikh boleh wrap */
    td.col-perihal,
    td.col-tempat,
    td.col-catat {
      white-space: normal !important;
    }

    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 6px;
      font-size: 0.8rem;
      color: var(--muted);
      gap: 6px;
      flex-wrap: wrap;
    }

    .error {
      color: var(--danger);
      font-size: 0.8rem;
      margin-top: 5px;
    }

    /* MODE MOBILE: setiap row jadi macam "kad" supaya catatan jelas dibaca */
    @media (max-width: 640px) {
      header h1 {
        font-size: 1.3rem;
      }

      .card {
        padding: 10px;
      }

      .table-wrapper {
        max-height: none;
      }

      table,
      thead,
      tbody,
      th,
      td,
      tr {
        display: block;
      }

      thead {
        display: none;
      }

      .table-wrapper {
        border: none;
        background: transparent;
      }

      tbody {
        display: block;
      }

      tr {
        margin-bottom: 12px;
        padding: 10px;
        border-radius: 10px;
        border: 1px solid rgba(148, 163, 184, 0.3);
        background: rgba(15, 23, 42, 0.9);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
      }

      td {
        border: none;
        padding: 6px 6px;
        position: relative;
        padding-left: 90px; /* ruang untuk label kiri */
        min-height: 26px;
        font-size: 0.8rem;
      }

      td::before {
        position: absolute;
        left: 10px;
        top: 6px;
        width: 70px;
        color: var(--accent);
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: capitalize;
      }

      td.col-tarikh::before { content: "Tarikh"; }
      td.col-perihal::before { content: "Perihal"; }
      td.col-tempat::before { content: "Tempat"; }
      td.col-catat::before { content: "Catatan"; }

      td.col-tarikh {
        text-align: left;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Paparan Aktiviti / Program APM Daerah Klang</h1>     
    </header>

    <div class="card">
      <div class="toolbar">
        <div class="toolbar-left">
          <div class="badge">
            <span class="badge-dot"></span>
            Live connected
          </div>
          <span class="last-update" id="lastUpdate">Sedang memuat data‚Ä¶</span>
        </div>

        <div class="controls">
          <select id="yearFilter" class="select-small">
            <option value="">Semua Tahun</option>
          </select>

          <select id="monthFilter" class="select-small">
            <option value="">Semua Bulan</option>
          </select>

          <div class="search-box">
            <span>üîç</span>
            <input
              type="text"
              id="searchInput"
              placeholder="Carian....."
            />
          </div>

          <button id="refreshBtn" class="refresh-btn" type="button">
            ‚Üª Refresh
          </button>
        </div>
      </div>

      <div class="table-wrapper">
        <table id="dataTable">
          <thead>
            <tr id="tableHeadRow">
              <!-- header diisi melalui JS -->
            </tr>
          </thead>
          <tbody id="tableBody">
            <!-- data diisi melalui JS -->
          </tbody>
        </table>
      </div>

      <div class="status-bar">
        <span id="rowCount">0 rekod</span>
        <span id="loadingStatus"></span>
      </div>

      <div class="error" id="errorBox"></div>
    </div>
  </div>

  <script>
    // URL Apps Script awak
    const API_URL = "https://script.google.com/macros/s/AKfycbxaeyLXNpIEBJlV5e_rExltO_SrQud-_MNs6W37mhO73y9OROx3cs5auZaZPvbmY2tz/exec";

    let allData = [];

    const tableHeadRow = document.getElementById("tableHeadRow");
    const tableBody = document.getElementById("tableBody");
    const rowCount = document.getElementById("rowCount");
    const loadingStatus = document.getElementById("loadingStatus");
    const errorBox = document.getElementById("errorBox");
    const lastUpdate = document.getElementById("lastUpdate");
    const searchInput = document.getElementById("searchInput");
    const yearFilter = document.getElementById("yearFilter");
    const monthFilter = document.getElementById("monthFilter");
    const refreshBtn = document.getElementById("refreshBtn");

    // Susunan kolum yang kita nak (logik)
    const COLUMN_ORDER = ["tarikh", "perihal", "tempat", "catatan"];

    // Peta: nama logik ‚Üí nama sebenar dalam JSON (case-insensitive)
    let headerMap = {};

    function normaliseHeaderName(name) {
      return name ? String(name).toLowerCase() : "";
    }

    function buildHeaderMap(sampleRow) {
      headerMap = {};
      const keys = Object.keys(sampleRow || {});

      COLUMN_ORDER.forEach((logical) => {
        const found = keys.find((k) => {
          const lower = normaliseHeaderName(k);
          return lower.includes(logical);
        });
        if (found) headerMap[logical] = found;
      });
    }

    async function loadData() {
      loadingStatus.textContent = "Memuat data dari Google Sheets‚Ä¶";
      errorBox.textContent = "";

      try {
        const res = await fetch(API_URL, { method: "GET" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        allData = Array.isArray(data) ? data : [];

        if (allData.length > 0) {
          buildHeaderMap(allData[0]);
          buildFilterOptions(allData);
        }

        applyFilters();

        const now = new Date();
        lastUpdate.textContent = "Kemas kini terakhir: " + now.toLocaleString("ms-MY");
        loadingStatus.textContent = "Selesai";
      } catch (err) {
        console.error(err);
        loadingStatus.textContent = "";
        errorBox.textContent = "Gagal memuat data. Sila cuba refresh laman ini.";
      }
    }

    function parseDateFromRow(row) {
      const key = headerMap.tarikh;
      if (!key) return null;
      const raw = row[key];
      if (!raw) return null;

      const d = new Date(raw);
      if (isNaN(d)) return null;
      return d;
    }

    function buildFilterOptions(data) {
      const yearSet = new Set();
      const monthSet = new Set();

      data.forEach((row) => {
        const d = parseDateFromRow(row);
        if (!d) return;
        const year = d.getFullYear();
        const month = d.getMonth() + 1;
        yearSet.add(year);
        monthSet.add(month);
      });

      // Reset options
      yearFilter.innerHTML = '<option value="">Semua Tahun</option>';
      monthFilter.innerHTML = '<option value="">Semua Bulan</option>';

      // Tahun (sort ascending)
      Array.from(yearSet)
        .sort((a, b) => a - b)
        .forEach((year) => {
          const opt = document.createElement("option");
          opt.value = String(year);
          opt.textContent = year;
          yearFilter.appendChild(opt);
        });

      // Bulan (1‚Äì12)
      const monthNames = [
        "", "Januari", "Februari", "Mac", "April", "Mei", "Jun",
        "Julai", "Ogos", "September", "Oktober", "November", "Disember"
      ];

      Array.from(monthSet)
        .sort((a, b) => a - b)
        .forEach((m) => {
          const opt = document.createElement("option");
          opt.value = String(m);
          opt.textContent = monthNames[m] || m;
          monthFilter.appendChild(opt);
        });
    }

    function formatDateForDisplay(value) {
      const d = new Date(value);
      if (isNaN(d)) return value || "";
      return d.toLocaleDateString("ms-MY", {
        day: "numeric",
        month: "numeric",
        year: "numeric",
      });
    }

    function renderTable(data) {
      tableBody.innerHTML = "";
      tableHeadRow.innerHTML = "";

      if (!data || data.length === 0) {
        rowCount.textContent = "0 rekod";
        return;
      }

      // Bina header table ikut susunan COLUMN_ORDER
      COLUMN_ORDER.forEach((logical) => {
        const actualKey = headerMap[logical];
        if (!actualKey) return; // skip kalau tak jumpa

        const th = document.createElement("th");
        // Papar nama original header dari sheet
        th.textContent = actualKey;
        if (logical === "tarikh") th.classList.add("col-tarikh");
        tableHeadRow.appendChild(th);
      });

      data.forEach((row) => {
        const tr = document.createElement("tr");

        COLUMN_ORDER.forEach((logical) => {
          const actualKey = headerMap[logical];
          if (!actualKey) return;

          let value = row[actualKey] ?? "";
          const lower = logical; // logical key dah lowercase

          const td = document.createElement("td");

          if (lower === "tarikh") {
            value = formatDateForDisplay(row[actualKey]);
            td.classList.add("col-tarikh");
          } else if (lower === "perihal") {
            td.classList.add("col-perihal");
          } else if (lower === "tempat") {
            td.classList.add("col-tempat");
          } else if (lower === "catatan") {
            td.classList.add("col-catat");
          }

          td.textContent = value;
          tr.appendChild(td);
        });

        tableBody.appendChild(tr);
      });

      rowCount.textContent = data.length + " rekod dipaparkan";
    }

    function applyFilters() {
      const term = searchInput.value.toLowerCase().trim();
      const yearVal = yearFilter.value;
      const monthVal = monthFilter.value;

      let filtered = allData.slice();

      // Tapis Tahun & Bulan
      if (yearVal || monthVal) {
        filtered = filtered.filter((row) => {
          const d = parseDateFromRow(row);
          if (!d) return false;
          const rowYear = d.getFullYear();
          const rowMonth = d.getMonth() + 1;

          if (yearVal && String(rowYear) !== yearVal) return false;
          if (monthVal && String(rowMonth) !== monthVal) return false;
          return true;
        });
      }

      // Tapis search
      if (term) {
        filtered = filtered.filter((row) => {
          return Object.values(row).some((v) =>
            String(v).toLowerCase().includes(term)
          );
        });
      }

      renderTable(filtered);
    }

    // Event listeners
    searchInput.addEventListener("input", () => {
      applyFilters();
    });

    yearFilter.addEventListener("change", () => {
      applyFilters();
    });

    monthFilter.addEventListener("change", () => {
      applyFilters();
    });

    refreshBtn.addEventListener("click", () => {
      // Clear filters & search, then reload dari server
      searchInput.value = "";
      yearFilter.value = "";
      monthFilter.value = "";
      loadData();
    });

    // Mula sekali
    loadData();
  </script>
</body>
</html>

